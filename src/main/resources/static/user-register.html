<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>User Register – ProConnect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif
        }

        body {
            min-height: 100vh;
            background: radial-gradient(circle at top, #0f172a, #020617 60%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
        }

        .card {
            width: 380px;
            background: rgba(15, 23, 42, .96);
            border-radius: 18px;
            padding: 26px;
            border: 1px solid rgba(148, 163, 184, .4);
            box-shadow: 0 0 35px rgba(56, 189, 248, .25);
        }

        h1 {
            text-align: center;
            font-size: 24px;
            color: #22c55e;
            margin-bottom: 4px;
            text-shadow: 0 0 14px rgba(34, 197, 94, .8);
        }

        h2 {
            text-align: center;
            font-size: 13px;
            font-weight: 400;
            color: #9ca3af;
            margin-bottom: 18px;
        }

        .label {
            font-size: 13px;
            margin: 8px 2px 4px;
            color: #cbd5f5
        }

        input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
            outline: none;
            font-size: 13px;
        }

        input:focus {
            border-color: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, .7);
        }

        button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: .2s;
        }

        .btn-otp {
            background: #06b6d4;
            color: #0f172a;
        }

        .btn-otp:hover {
            background: #22d3ee;
            box-shadow: 0 0 12px rgba(34, 211, 238, .7);
        }

        .btn-register {
            background: #22c55e;
            color: #022c22;
        }

        .btn-register:hover {
            background: #4ade80;
            box-shadow: 0 0 12px rgba(74, 222, 128, .7);
        }

        .status {
            font-size: 12px;
            margin-top: 8px;
            padding: 6px 10px;
            border-radius: 8px;
        }

        .status.ok {
            background: rgba(22, 163, 74, .15);
            color: #bbf7d0;
        }

        .status.err {
            background: rgba(220, 38, 38, .15);
            color: #fecaca;
        }

        .small {
            margin-top: 12px;
            font-size: 11px;
            text-align: center;
            color: #6b7280;
        }

        .link {
            color: #38bdf8;
            cursor: pointer
        }
    </style>
</head>

<body>

    <div class="card">
        <h1>ProConnect</h1>
        <h2>User Registration (OTP)</h2>

        <div class="label">Full Name</div>
        <input id="nameInput" placeholder="Your name">

        <div class="label">Email</div>
        <input id="emailInput" placeholder="you@example.com">

        <div class="label">Password</div>
        <input id="passwordInput" type="password" placeholder="Choose password">

        <div class="label">OTP (from email)</div>
        <input id="otpInput" placeholder="Enter 6-digit OTP">

        <button class="btn-otp" onclick="sendOtp()">Send OTP</button>
        <button class="btn-register" onclick="verifyAndRegister()">Verify & Register</button>

        <div id="msg" class="status" style="display:none;"></div>

        <div class="small">
            Already have an account? <span class="link" onclick="goLogin()">Go to Login</span>
        </div>
    </div>

    <script>
        function showMsg(text, ok) {
            const el = document.getElementById('msg');
            el.style.display = 'block';
            el.className = 'status ' + (ok ? 'ok' : 'err');
            el.innerText = text;
        }

        const gmailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
        // At least 8 chars, 1 upper, 1 lower, 1 number, 1 special
        const passRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

        async function sendOtp() {
            const email = emailInput.value.trim();
            if (!email) return showMsg("Enter email first", false);
            if (!gmailRegex.test(email)) return showMsg("Only @gmail.com is allowed", false);

            const body = { email: email, role: "USER" };

            try {
                const res = await fetch('/auth/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const text = await res.text();
                showMsg(text, res.ok);
            } catch (e) {
                showMsg("Failed to send OTP", false);
            }
        }

        async function verifyAndRegister() {
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const otp = otpInput.value.trim();

            if (!name || !email || !password || !otp) {
                return showMsg("Fill all fields + OTP", false);
            }
            if (!gmailRegex.test(email)) {
                return showMsg("Only @gmail.com is allowed", false);
            }
            if (!passRegex.test(password)) {
                return showMsg("Password weak: Use 8+ chars, Upper, Lower, Number, Special", false);
            }

            const body = {
                name, email, password,
                role: "USER",
                otp: otp
            };

            try {
                const res = await fetch('/auth/register-with-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const text = await res.text();
                if (!res.ok) {
                    return showMsg("Register failed: " + text, false);
                }
                showMsg("User registered successfully ✔ Redirecting...", true);
                setTimeout(() => {
                    window.location.href = "/user-login.html";
                }, 1000);
            } catch (e) {
                showMsg("Server error", false);
            }
        }

        function goLogin() {
            window.location.href = "/user-login.html";
        }
    </script>
</body>

</html>